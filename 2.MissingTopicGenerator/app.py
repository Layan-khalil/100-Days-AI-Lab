import streamlit as st
from google import genai
from google.genai import types
import json 
import pandas as pd

# =================================================================
# 1. ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ ูุงูุงุณุชุฌุงุจุฉ (RTL & Wide Layout)
# =================================================================

st.set_page_config(
    page_title=" ูููุดุฆ ุงููุญุชูู ุงูููููุฏ",
    layout="wide",
    initial_sidebar_state="collapsed",
)

# --- ุชุญููู ููู ุงูุณุชุงูู (styles.css) ---
def load_style():
    """ูุญูู ุชูุณููุงุช RTL ูุงูุฎุทูุท ูู ููู styles.css."""
    # ููุชุฑุถ ุฃู styles.css ููุฌูุฏ ูู ููุณ ูุณุงุฑ app.py
    try:
        with open("styles.css", encoding="utf-8") as f:
            st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)
    except FileNotFoundError:
        # ููุนุฑุถ ูุฐุง ุงูุชุญุฐูุฑ ุฅุฐุง ูุงู ููู ุงูู CSS ููููุฏูุง
        st.warning("โ๏ธ ุฎุทุฃ! ููู styles.css ุบูุฑ ููุฌูุฏ. ูุฑุฌู ุงูุชุฃูุฏ ูู ูุถุนู ูู ููุณ ุงููุฌูุฏ ูุน app.py.")

load_style()

# =================================================================
# 2. ุชููุฆุฉ ูููุฐุฌ Gemini
# =================================================================
client = None
try:
    # โ๏ธ ููุฑุฃ ุงูููุชุงุญ ูู secrets.toml ุงูุฐู ูุฌุจ ุฃู ูููู ูู ููุณ ุงููุฌูุฏ
    API_KEY = st.secrets["GEMINI_API_KEY"]
    client = genai.Client(api_key=API_KEY)
except KeyError:
    st.error("ุฎุทุฃ: ูุฑุฌู ุงูุชุฃูุฏ ูู ุชุนููู ุงูููุชุงุญ ุจุงุณู 'GEMINI_API_KEY' ูู ููู secrets.toml ุฏุงุฎู ูุฐุง ุงููุฌูุฏ.")
    st.stop()
except Exception as e:
    st.error(f"ุฎุทุฃ ุบูุฑ ูุชููุน ุฃุซูุงุก ุงูุชููุฆุฉ: {e}")
    st.stop()


# =================================================================
# 3. ุฏุงูุฉ ุชุญููู ุงููุฌูุงุช (ูุน ุทูุจ JSON ููุธู)
# =================================================================

def analyze_content_gaps(my_posts, competitor_posts):
    """
    ูุญูู ุงููุญุชูู ุงููููุงุฑูู ููุณุชุฎุฑุฌ ููุงุถูุน ุบูุฑ ูุบุทุงุฉ ููุทููุจุฉ ุจุงุณุชุฎุฏุงู Gemini API.
    """
    system_prompt = (
        "ุฃูุช ุฎุจูุฑ ุงุณุชุฑุงุชูุฌู ูู ุงููุญุชูู ุงูุชุณูููู ูุชุฎุตุต ูู ุชุญููู ุงููุฌูุงุช (Gap Analysis). "
        "ูููุชู ูู ููุงุฑูุฉ ูุงุฆูุฉ ููุดูุฑุงุช ุงูุนููู ูุน ููุดูุฑุงุช ุงูููุงูุณููุ ูุชุญุฏูุฏ 5-7 ููุงุถูุน ุฑุฆูุณูุฉ "
        "ูู ูุชู ุชุบุทูุชูุง ุจุดูู ูุงูู ุฃู ุชู ุฅููุงููุงุ ูููู ูู ุงููุฑุฌุญ ุฃู ุชููู ูุทููุจุฉ ูู ูุจู ุงูุฌูููุฑ. "
        "ูุฌุจ ุฃู ุชููู ุงููุฎุฑุฌุงุช ูู ุชูุณูู JSON ุญุตุฑุงู."
    )
    
    prompt = (
        f"ูู ุจุชุญููู ุงูููุงุฆู ุงูุชุงููุฉ ูุชุญุฏูุฏ ูุฑุต ุงููุญุชูู ุบูุฑ ุงููุบุทุงุฉ ูุงููุฌูุงุช ุงููุนุฑููุฉ ุงูุชู ูุฌุจ ุนูู ุงูุนููู ุงูุชุฑููุฒ ุนูููุง. "
        f"ูุงุฆูุฉ ููุดูุฑุงุช ุงูุนููู:\n{my_posts}\n\n"
        f"ูุงุฆูุฉ ููุดูุฑุงุช ุงูููุงูุณูู:\n{competitor_posts}"
    )

    response = client.models.generate_content(
        model='gemini-2.5-flash',
        contents=prompt,
        config=types.GenerateContentConfig(
            system_instruction=system_prompt,
            response_mime_type="application/json",
            # ุชุญุฏูุฏ ูุฎุทุท JSON ูุถูุงู ุฅุฎุฑุงุฌ ููุธู
            response_schema={
                "type": "OBJECT",
                "properties": {
                    "missing_topics": {
                        "type": "ARRAY",
                        "description": "ูุงุฆูุฉ ุจุงูููุงุถูุน ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุชู ูุฌุจ ุชุบุทูุชูุง",
                        "items": {
                            "type": "OBJECT",
                            "properties": {
                                "topic_title": {"type": "STRING", "description": "ุนููุงู ุงูููุถูุน ุงูููููุฏ ุงูููุชุฑุญ."},
                                "gap_reason": {"type": "STRING", "description": "ุณุจุจ ุฃูููุฉ ุงูููุถูุน (ูุซู: ุงูููุงูุณูู ูุชุฌุงูููููุ ุฃู ูู ุทูุจ ุถููู ููุฌูููุฑ)."},
                                "format_suggestion": {"type": "STRING", "description": "ุดูู ุงููุญุชูู ุงูููุชุฑุญ (ูุซู: ููุฏูู ูุตูุฑุ ููุงูุ ุจุซ ูุจุงุดุฑ)."}
                            }
                        }
                    },
                    "summary_analysis": {"type": "STRING", "description": "ููุฎุต ุนุงู ูููุท ุงููุญุชูู ุงูุญุงูู ููุนููู ูุงูููุงูุณูู."}
                }
            }
        )
    )
    
    try:
        # ูุญุงููุฉ ุชุญููู ุงุณุชุฌุงุจุฉ JSON
        return json.loads(response.text)
    except json.JSONDecodeError:
        st.error(f"ุฎุทุฃ ูู ุชุญููู ุงุณุชุฌุงุจุฉ ุงููููุฐุฌ: ุงูุฑุฏ ุบูุฑ ููููู. ุงูุฑุฏ: {response.text}")
        return None

# =================================================================
# 4. ูุงุฌูุฉ ุงููุณุชุฎุฏู (Streamlit UI)
# =================================================================

st.title("๐ ูููุดุฆ ุงููุญุชูู ุงูููููุฏ (Missing Topic Generator)")
st.caption("ุฃุฏุงุฉ ุชุญููู ุงููุฌูุงุช: ุงูุชุดู ุงูููุงุถูุน ุงูุชู ูุชุฌุงูููุง ุงูุฌููุน ูููููุง ูุทููุจุฉ ุจุดุฏุฉ ูู ุฌูููุฑู.")
st.markdown("---")

col1, col2 = st.columns(2)

with col1:
    my_posts_input = st.text_area(
        "ููุดูุฑุงุชู ุงูุนุดุฑุฉ ุงูุฃุฎูุฑุฉ (ุฃูุตู ุงูุนูุงููู ุฃู ููุฎุตุงุชูุง ููุง):",
        height=300,
        placeholder="ูุซุงู:\n1. 5 ุฃุฎุทุงุก ุดุงุฆุนุฉ ูู ุงูุชุณููู\n2. ููู ุชููู ุนูู TikTok ูู 30 ูููุงู\n3. ููุงุจูุฉ ูุน ุฎุจูุฑ ุงูุชูููู..."
    )

with col2:
    competitor_posts_input = st.text_area(
        "ููุดูุฑุงุช ุงูููุงูุณูู ุงูุนุดุฑุฉ ุงูุฃุฎูุฑุฉ (ุฃูุตู ุงูุนูุงููู ุฃู ููุฎุตุงุชูุง ููุง):",
        height=300,
        placeholder="ูุซุงู:\n1. ุฃูููุฉ ุงูุฅุถุงุกุฉ ูู ุงูููุฏูู\n2. ุฏุฑูุณ ูุฌุงููุฉ ูู Photoshop\n3. ุฎุทุฉ ุงุณุชุฑุงุชูุฌูุฉ ูุนุงู 2024..."
    )

analyze_button = st.button("ุชุญููู ุงููุฌูุงุช ูุงูุชุฑุงุญ ุงูููุงุถูุน", type="primary")

if analyze_button and my_posts_input and competitor_posts_input:
    if len(my_posts_input.strip()) < 50 or len(competitor_posts_input.strip()) < 50:
        st.warning("ูุฑุฌู ุฅุฏุฎุงู ูุญุชูู ูุงูู (ูุง ูุง ููู ุนู 50 ุญุฑูุงู ููู ูุงุฆูุฉ) ูุฅุฌุฑุงุก ุชุญููู ุฏููู.")
    else:
        with st.spinner("ุฌุงุฑู ุชุญููู ุงููุญุชูู ุงููููุงุฑูู ูุงูุชุดุงู ุงููุฌูุงุช ุงูุงุณุชุฑุงุชูุฌูุฉ..."):
            analysis_result = analyze_content_gaps(my_posts_input, competitor_posts_input)

        if analysis_result:
            st.markdown("## ๐ฏ ุงููุฑุต ุงูููููุฏุฉ: ููุงุถูุน ูุฌุจ ุชุบุทูุชูุง ููุฑุงู")
            st.success("ุชู ุชุญููู ุงููุฌูุงุช ุจูุฌุงุญ. ุฅููู ุฃูู 5-7 ููุงุถูุน ููุชุฑุญุฉ:")
            
            st.markdown("### ููุฎุต ุชุญููู ุงูููุท ุงูุนุงู:")
            st.markdown(analysis_result.get('summary_analysis', 'ูุง ููุฌุฏ ููุฎุต ูุชููุฑ.'))

            st.markdown("---")
            
            missing_topics = analysis_result.get('missing_topics', [])
            
            if missing_topics:
                # ุฅูุดุงุก ุฌุฏูู ูุนุฑุถ ุงููุชุงุฆุฌ ุจุดูู ููุธู
                df = pd.DataFrame(missing_topics)
                df.columns = ["ุงูููุถูุน ุงูููุชุฑุญ", "ุณุจุจ ุงูุฃูููุฉ ูุงููุฌูุฉ", "ุงูุชุฑุงุญ ุงูุดูู"]
                
                st.dataframe(df, use_container_width=True)
            else:
                st.info("ุงููููุฐุฌ ูู ูุญุฏุฏ ููุงุถูุน ููููุฏุฉ ูุงุถุญุฉ. ูุฏ ุชููู ุงูููุงุฆู ูุชุดุงุจูุฉ ุฌุฏุงู.")

elif analyze_button:
    st.warning("ูุฑุฌู ุฅุฏุฎุงู ุจูุงูุงุช ููุดูุฑุงุชู ูููุดูุฑุงุช ุงูููุงูุณูู ููููุงุฑูุฉ.")